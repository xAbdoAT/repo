name: ğŸ› ï¸ ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø­Ø²Ù… (Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)

on:
  push:
    paths:
      - 'debs/**'
  workflow_dispatch:

jobs:
  update_repo:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” ÙØ­Øµ Ù…Ø¬Ù„Ø¯ debs
        id: check_debs
        run: |
          mkdir -p debs
          COUNT=$(find debs/ -maxdepth 1 -name '*.deb' | wc -l)
          echo "ğŸ“‚ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø²Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©: $COUNT"
          echo "has_debs=$([ $COUNT -gt 0 ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      - name: âš™ï¸ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
        if: steps.check_debs.outputs.has_debs == 'true'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -yqq dpkg-dev bzip2 xz-utils

      - name: ğŸ“¦ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙ‡Ø±Ø³
        if: steps.check_debs.outputs.has_debs == 'true'
        run: |
          touch override
          if ! dpkg-scanpackages -m debs override > Packages 2>warnings.log; then
            echo "âš ï¸ Ø¸Ù‡Ø±Øª ØªØ­Ø°ÙŠØ±Ø§Øª:"
            cat warnings.log
          fi
          bzip2 -kf Packages
          xz -kf Packages
          gzip -kf Packages
          echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Ø§Ù„ÙÙ‡Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­"

      - name: â„¹ï¸ Ø¥Ø¹Ù„Ø§Ù… Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø­Ø²Ù…
        if: steps.check_debs.outputs.has_debs == 'false'
        run: echo "##[notice] Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª .deb ÙÙŠ Ù…Ø¬Ù„Ø¯ debsØŒ ØªÙ… ØªØ®Ø·ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©"

      - name: ğŸ”„ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        if: steps.check_debs.outputs.has_debs == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[github.com]"
          git add Packages*
          if git diff-index --quiet HEAD --; then
            echo "ğŸ†— Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ø±ÙØ¹Ù‡Ø§"
          else
            git commit -m "ğŸ”„ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ÙÙ‡Ø±Ø³ [skip ci]"
            git pull --rebase
            git push
          fi